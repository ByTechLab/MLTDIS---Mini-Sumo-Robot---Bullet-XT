/*
* LCD.c
*
* Created: 2016-05-30 12:24:19
*  Author: Andrzej
*/
//SPI initialize for SD card

#include "Includes.h"


const unsigned char IMG_intro[] PROGMEM = {
	#include "IMG_intro.h"
};

const unsigned char font[] PROGMEM = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x5f,0x00,0x00,0x00,0x00,0x07,0x00,0x07,
	0x00,0x00,0x14,0x7f,0x14,0x7f,0x14,0x00,0x24,0x2a,0x7f,0x2a,0x12,0x00,0x23,0x13,
	0x08,0x64,0x62,0x00,0x36,0x49,0x55,0x22,0x50,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
	0x00,0x1c,0x22,0x41,0x00,0x00,0x00,0x41,0x22,0x1c,0x00,0x00,0x14,0x08,0x3e,0x08,
	0x14,0x00,0x08,0x08,0x3e,0x08,0x08,0x00,0x00,0x50,0x30,0x00,0x00,0x00,0x08,0x08,
	0x08,0x08,0x08,0x00,0x00,0x60,0x60,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x00,
	0x3e,0x51,0x49,0x45,0x3e,0x00,0x00,0x42,0x7f,0x40,0x00,0x00,0x42,0x61,0x51,0x49,
	0x46,0x00,0x21,0x41,0x45,0x4b,0x31,0x00,0x18,0x14,0x12,0x7f,0x10,0x00,0x27,0x45,
	0x45,0x45,0x39,0x00,0x3c,0x4a,0x49,0x49,0x30,0x00,0x03,0x71,0x09,0x05,0x03,0x00,
	0x36,0x49,0x49,0x49,0x36,0x00,0x06,0x49,0x49,0x29,0x1e,0x00,0x00,0x36,0x36,0x00,
	0x00,0x00,0x00,0x56,0x36,0x00,0x00,0x00,0x08,0x14,0x22,0x41,0x00,0x00,0x14,0x14,
	0x14,0x14,0x14,0x00,0x00,0x41,0x22,0x14,0x08,0x00,0x02,0x01,0x51,0x09,0x06,0x00,
	0x32,0x49,0x79,0x41,0x3e,0x00,0x7e,0x11,0x11,0x11,0x7e,0x00,0x7f,0x49,0x49,0x49,
	0x36,0x00,0x3e,0x41,0x41,0x41,0x22,0x00,0x7f,0x41,0x41,0x41,0x3e,0x00,0x7f,0x49,
	0x49,0x49,0x41,0x00,0x7f,0x09,0x09,0x09,0x01,0x00,0x3e,0x41,0x41,0x49,0x7a,0x00,
	0x7f,0x08,0x08,0x08,0x7f,0x00,0x00,0x41,0x7f,0x41,0x00,0x00,0x20,0x40,0x41,0x3f,
	0x01,0x00,0x7f,0x08,0x14,0x22,0x41,0x00,0x7f,0x40,0x40,0x40,0x40,0x00,0x7f,0x02,
	0x0c,0x02,0x7f,0x00,0x7f,0x04,0x08,0x10,0x7f,0x00,0x3e,0x41,0x41,0x41,0x3e,0x00,
	0x7f,0x09,0x09,0x09,0x06,0x00,0x3e,0x41,0x51,0x21,0x5e,0x00,0x7f,0x09,0x19,0x29,
	0x46,0x00,0x46,0x49,0x49,0x49,0x31,0x00,0x01,0x01,0x7f,0x01,0x01,0x00,0x3f,0x40,
	0x40,0x40,0x3f,0x00,0x1f,0x20,0x40,0x20,0x1f,0x00,0x3f,0x40,0x38,0x40,0x3f,0x00,
	0x63,0x14,0x08,0x14,0x63,0x00,0x07,0x08,0x70,0x08,0x07,0x00,0x61,0x51,0x49,0x45,
	0x43,0x00,0x00,0x7f,0x41,0x41,0x00,0x00,0x02,0x04,0x08,0x10,0x20,0x00,0x00,0x41,
	0x41,0x7f,0x00,0x00,0x04,0x02,0x01,0x02,0x04,0x00,0x40,0x40,0x40,0x40,0x40,0x00,
	0x00,0x01,0x02,0x04,0x00,0x00,0x20,0x54,0x54,0x54,0x78,0x00,0x7f,0x48,0x44,0x44,
	0x38,0x00,0x38,0x44,0x44,0x44,0x20,0x00,0x38,0x44,0x44,0x48,0x7f,0x00,0x38,0x54,
	0x54,0x54,0x18,0x00,0x08,0x7e,0x09,0x01,0x02,0x00,0x18,0xa4,0xa4,0xa4,0x7c,0x00,
	0x7f,0x08,0x04,0x04,0x78,0x00,0x00,0x48,0x7d,0x40,0x00,0x00,0x00,0x00,0x84,0x7d,
	0x00,0x00,0x7f,0x10,0x28,0x44,0x00,0x00,0x00,0x41,0x7f,0x40,0x00,0x00,0x7c,0x04,
	0x78,0x04,0x78,0x00,0x7c,0x08,0x04,0x04,0x78,0x00,0x38,0x44,0x44,0x44,0x38,0x00,
	0xfc,0x24,0x24,0x24,0x18,0x00,0x18,0x24,0x24,0x28,0xfc,0x00,0x7c,0x08,0x04,0x04,
	0x08,0x00,0x48,0x54,0x54,0x54,0x20,0x00,0x04,0x3f,0x44,0x40,0x20,0x00,0x3c,0x40,
	0x40,0x20,0x7c,0x00,0x1c,0x20,0x40,0x20,0x1c,0x00,0x3c,0x40,0x30,0x40,0x3c,0x00,
	0x44,0x28,0x10,0x28,0x44,0x00,0x1c,0xa0,0xa0,0xa0,0x7c,0x00,0x44,0x64,0x54,0x4c,
	0x44,0x00,0x00,0x08,0x36,0x41,0x00,0x00,0x00,0x00,0x7f,0x00,0x00,0x00,0x00,0x41,
	0x36,0x08,0x00,0x00,0x10,0x08,0x08,0x10,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x20,0x54,0x54,0xd4,0x78,0x00,0x38,0x44,0x46,0x45,0x20,0x00,0x38,0x54,0x54,0xd4,
	0x18,0x00,0x00,0x49,0x7f,0x44,0x00,0x00,0x7c,0x08,0x06,0x05,0x78,0x00,0x38,0x44,
	0x46,0x45,0x38,0x00,0x48,0x54,0x56,0x55,0x20,0x00,0x44,0x64,0x56,0x4d,0x44,0x00,
	0x44,0x64,0x55,0x4c,0x44,0x00,0x7e,0x11,0x11,0x91,0x7e,0x00,0x3c,0x42,0x46,0x43,
	0x24,0x00,0x7f,0x49,0x49,0xc9,0x41,0x00,0x7f,0x50,0x48,0x44,0x40,0x00,0x7e,0x04,
	0x0b,0x10,0x7e,0x00,0x3c,0x42,0x46,0x43,0x3c,0x00,0x4c,0x52,0x56,0x53,0x22,0x00,
	0x42,0x66,0x53,0x4a,0x46,0x00,0x42,0x62,0x53,0x4a,0x46,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};



void init_SPI_LCD(void)
{
	PORTE.DIRSET = PIN4_bm|PIN5_bm|PIN7_bm;
	PORTE.DIRCLR = PIN6_bm;
	SPIE.CTRL = SPI_MODE_0_gc|SPI_ENABLE_bm|SPI_PRESCALER_DIV16_gc|SPI_MASTER_bm;
}

// Wysy³a jeden bajt do LCD z u¿yciem sprzêtowego SPI
// c_d: LCD_DATA|LCD_CMD
void LCD_write_byte(unsigned char c_d, unsigned char data )
{
	LCD_SS_OFF//LCD_CE_CLR
	if(c_d)
	LCD_DC_ON
	else
	LCD_DC_OFF
	SPIE.DATA = data;//SPDR = data;
	while(!(SPIE.STATUS & SPI_IF_bm));//while(!(SPSR & (1<<SPIF)));
	LCD_SS_ON
}

// Wyœwietla obrazek
// img, x0,y0,width, height/8
void LCD_image(unsigned char s[],char  x, char y, char w, char h)
{
	unsigned int i,j,k;
	
	for(i=0,j=0,k=0; i<h; i++)
	{
		LCD_write_byte(LCD_CMD, 0x40|(i+y));
		LCD_write_byte(LCD_CMD, 0x80|(x));

		for(j=0; j<w ; j++,k++)
		LCD_write_byte(LCD_DATA, pgm_read_byte(&s[k]));
	}
}

void LCD_clear(void)
{
	unsigned char  i,j;
	
	LCD_HOME
	
	for(i=0; i<LCD_Y; i++)
	{
		LCD_GOTO(0, i)
		for(j=0; j<LCD_X; j++)
		LCD_write_byte(LCD_DATA, 0x00);
	}

	LCD_HOME
}

void LCD_text(char s[], unsigned char x, unsigned char y)
{
	unsigned int c,j;
	unsigned char i,k;

	// Kody polskich literek z ogonkami
	char pl[] = {'¹','æ','ê','³','ñ','ó','œ','Ÿ','¿','¥','Æ','Ê','£','Ñ','Ó','Œ','','¯'};
	
	// Ustawia po³o¿enia pierwszej litery tekstu na ekranie LCD
	LCD_write_byte(LCD_CMD, LCD_SETY|(y));
	LCD_write_byte(LCD_CMD, LCD_SETX|(x));

	// Rysuje znak po znaku
	for(k=0; (c = s[k]); k++)
	{
		// Dopasowuje kody znaków z ogonkami
		for(i=0; (i<18) && (pl[i]!=c); i++) ;
		if(i<18) c= 0x80+i;

		// Kopiuje jeden znak(6x8) z FLASH do pamiêci obrazu LCD
		for(i=0, j=(c-32)*6; i<6; i++,j++)
		LCD_write_byte(LCD_DATA, pgm_read_byte(&font[j]));
	}
}

void LCD_menu_print(void)
{
	LCD_text("1.CH MODE", 6, 0);
	LCD_text("2.START STOP", 6, 1);
	LCD_text("3.TEST SENS", 6, 2);
	LCD_text("4.TOG LEDS", 6, 3);
	LCD_text("5.VOLTAGE", 6, 4);
	LCD_text("6.TEST MOT", 6, 5);
}
void LCD_menu_mode_print(void)
{
	LCD_text("1.S.TORNADO", 6, 0);
	LCD_text("2.S.STANDARD", 6, 1);
	LCD_text("3.S.LF", 6, 2);
	LCD_text("4.------", 6, 3);
	LCD_text("5.------", 6, 4);
	LCD_text("6.---->>", 6, 5);
}
void LCD_menu_handle(void)
{
	if (BTN_s._1==1)
	{
		Menu_option_counter++;
		if (Menu_option_counter>5)Menu_option_counter=5;
		LCD_clear();
		if(Menu_sub_flag==SUBMENU_MAIN)LCD_menu_print();
		else if(Menu_sub_flag==SUBMENU_MODE) LCD_menu_mode_print();
		LCD_text(">", 0, Menu_option_counter);
		BUZZ_beep(10);
		BTN_s._1=0;
	}
	if (BTN_s._2==1)
	{
		Menu_option_counter--;
		if (Menu_option_counter<0)Menu_option_counter=0;
		LCD_clear();
		if(Menu_sub_flag==SUBMENU_MAIN)LCD_menu_print();
		else if(Menu_sub_flag==SUBMENU_MODE) LCD_menu_mode_print();
		LCD_text(">", 0, Menu_option_counter);
		BUZZ_beep(10);
		BTN_s._2=0;
	}
	
	if (BTN_s._3==1)
	{
		switch (Menu_sub_flag)
		{
			case SUBMENU_MAIN :
			switch (Menu_option_counter)
			{
				case 0 :
				LCD_clear();
				LCD_menu_mode_print();
				LCD_text(">", 0, Menu_option_counter);
				Menu_sub_flag=SUBMENU_MODE;
				break;
				
				case 1 :// toggle start stop flag
				GP_FLAGS_s.START_STOP ^= 1 << 0;
				BUZZ_beep(10);
				break;
				
				case 2 :
				LCD_clear();
				while (BUTTON_4_CHECK == 0)
				{
					if (SENS_FLAG_s.LINE_LEFT==1)
					{
						LCD_text("L.LINE", 0, 0);
						SENS_FLAG_s.LINE_LEFT=0;
						_delay_ms(250);
					}
					else LCD_text("      ", 0, 0);
					
					if (SENS_FLAG_s.LINE_RIGHT==1)
					{
						LCD_text("R.LINE", 6*6, 0);
						SENS_FLAG_s.LINE_RIGHT=0;
						_delay_ms(250);
					}
					else LCD_text("      ", 6*6, 0);
					
					if (SENS_FLAG_s.SHARP_A_FRONT==1)
					{
						LCD_text("SHARP A FRONT", 0, 1);
						SENS_FLAG_s.SHARP_A_FRONT=0;
						_delay_ms(250);
					}
					else LCD_text("             ", 0, 1);
					
					if (SENS_FLAG_s.SHARP_A_LEFT==1)
					{
						LCD_text("SHARP A LEFT", 0, 2);
						SENS_FLAG_s.SHARP_A_LEFT=0;
						_delay_ms(250);
					}
					else LCD_text("             ", 0, 2);
					
					if (SENS_FLAG_s.SHARP_A_RIGHT==1)
					{
						LCD_text("SHARP A RIGHT", 0, 3);
						SENS_FLAG_s.SHARP_A_RIGHT=0;
						_delay_ms(250);
					}
					else LCD_text("             ", 0, 3);
					
					if (SENS_FLAG_s.SHARP_DIGIT==1)
					{
						LCD_text("SHARP D FRONT", 0, 3);
						SENS_FLAG_s.SHARP_DIGIT=0;
						_delay_ms(250);
					}
					else LCD_text("             ", 0, 3);
				}
				BUZZ_beep(10);
				LCD_menu_print();
				LCD_text(">", 0, Menu_option_counter);
				break;
				
				case 3 :
				LED_toggle();
				BUZZ_beep(10);
				break;
				
				case 4 :
				LCD_clear();
				sprintf(buff,"Volt:%d",ReadADC(MEAS_BAT_V));
				LCD_text(buff, 6, 0);
				BUZZ_beep(10);
				break;
				
				case 5 :
				BUZZ_beep(10);
				MOT_go_forward(50);
				_delay_ms(250);
				MOT_stop();
				break;
			}
			break;
			
			case SUBMENU_MODE :
			switch (Menu_option_counter)
			{
				case 0 :
				GP_FLAGS_s.MODE=MODE_TORNADO;
				BUZZ_beep(10);
				break;
				
				case 1 :
				GP_FLAGS_s.MODE=MODE_STANDARD;
				BUZZ_beep(10);
				break;
				
				case 2 :
				GP_FLAGS_s.MODE=MODE_LF;
				BUZZ_beep(10);
				break;
				
				case 5 : // go up menu
				Menu_sub_flag=SUBMENU_MAIN;
				BUZZ_beep(10);
				LCD_clear();
				LCD_menu_print();
				LCD_text(">", 0, Menu_option_counter);
				break;
			}
			break;
			
			case SUBMENU_TEST_SENS :
			break;
			
			case SUBMENU_VOLTAGE :
			break;
		}
		BTN_s._3=0;
	}
	
	if (BTN_s._4==1)
	{
		BTN_s._4=0;
	}
	
}

void init_LCD(void)
{
	LCD_RST_OFF//LCD_RST_CLR;
	//   < 30ms
	_delay_ms(150);
	
	LCD_RST_ON//LCD_RST_SET
	_delay_ms(150);
	LCD_SS_ON//LCD_CE_SET
	
	LCD_write_byte(LCD_CMD, 0x21); // Function set - extended instruction set
	LCD_write_byte(LCD_CMD, 0x13); // Bias - 1:48
	LCD_write_byte(LCD_CMD, 0x06); // Temperature Control
	LCD_write_byte(LCD_CMD, 0b10000000|70); // Set Vop
	LCD_write_byte(LCD_CMD, 0x20); // Function set - basic instruction set, horizontal addressing
	LCD_write_byte(LCD_CMD, 0x0C); // Display control - normal mode
	
	LCD_image(IMG_intro,0,0,84,6);
	LCD_text("BULLET XT v0.9", 0, 0);
	_delay_ms(2500);
	LCD_text("               ", 0, 0);
	LCD_text("DESGNED BY:", 0, 0);
	_delay_ms(2500);
	LCD_text("ANDRZEJ LACZEWSKI", 0, 0);
	_delay_ms(2500);
	LCD_clear();
	LCD_menu_print();
	LCD_text(">", 0, 0);
	
	BTN_s._1=0;
	BTN_s._2=0;
	BTN_s._3=0;
	BTN_s._4=0;
	Menu_option_counter=0;
	Menu_sub_flag=SUBMENU_MAIN;
}